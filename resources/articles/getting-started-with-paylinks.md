:title Getting started with Paylinks

:aside

## Prerequisites

In order to complete this guide, you need to know your:

- client ID
- client secret

You should also have gone through the [Getting Started](/getting-started/)
guide. In particular, you should have downloaded and installed the appropriate
SDK for your platform.

:body

When you have completed this guide, you can sell products by allowing users to
check out and pay via Schibsted account.

## Overview

This is the flow:

- The user chooses product(s) on your website.
- You send the list of items to Schibsted account, and get a unique URL back. Redirect the
  user to this Paylink URL.
- The user completes payment on the Schibsted account website, and is redirected back to your site with an order ID.
- You refresh your user info, and track the status of payment with the order ID.

It's illustrated in [this sequence diagram](/paylink-api/#purchase-flows).

We'll look at these steps in detail in the rest of the guide. If you prefer to just
dive in, take a look at [these working examples](#working-examples).

## Configure your application

These variables change between production and staging environments:

- Your client ID
- Your client secret
- Your client signature secret
- The base URL to Schibsted account
- Your base URL

How you choose to configure your application is up to you, but
these variables should not be hard-coded.

## The user chooses products on your website

Here are some things to keep in mind when implementing paylinks on your site:

- Before you create the Paylink, you need to know what items the user wants to purchase,
  as well as the price, VAT and quantities of each.
- Schibsted account will present the user with a summary of the items, and a total price.
  Quantities can not be changed at this point.

In the example, we're keeping it simple with three products - each with an input
field to specify quantity:

<spid-example lang="html" repo="clj" src="/paylinks/resources/index.html" title="Keeping product choices simple"/>

## Send the list of items to Schibsted account

We prepare the purchase by creating a Paylink - which has a URL to which we can
redirect the user for payment.

To [create a Paylink](/endpoints/POST/paylink/), Schibsted account expects a few parameters:

- `items` A list of items as a JSON-string, each item with: `description`, `price`, `vat` and `quantity`
- `title` A description shown to the user on the payment page.
- `redirectUri` Where Schibsted account should send the user after a successful payment
- `cancelUri` Where Schibsted account should send the user after a cancelled payment
- `clientReference` Your reference, for tracking and processing the order generated by this PayLink

We'll take the quantities posted by the user, and create the data.

**NB!** If you store products in Schibsted account, you can pass on `productId` when creating
paylinks. Refer to the [reference documentation](/endpoints/POST/paylink/) for
all options.

# :tabs

## :tab Java

<spid-example lang="java" src="/paylinks/src/main/java/no/spid/examples/PaylinksController.java" title="The entirety of our product catalog right here"/>

<spid-example lang="java" src="/paylinks/src/main/java/no/spid/examples/PaylinksController.java" title="Create data to POST to /paylink"/>

Note that the items are encoded as a JSON string.

## :tab Clojure

<spid-example lang="clj" src="/paylinks/src/spid_clojure_paylinks_example/core.clj" title="The entirety of our product catalog right here"/>

<spid-example lang="clj" src="/paylinks/src/spid_clojure_paylinks_example/core.clj" title="Create data to POST to /paylink"/>

Note that the items are encoded as a JSON string.

# :/tabs

#### Create paylink

With our data in hand, we can create the Paylink by POSTing to
[the /paylinks endpoint](/endpoints/POST/paylink/).

# :tabs

## :tab Java

<spid-example lang="java" src="/paylinks/src/main/java/no/spid/examples/PaylinksController.java" title="Create SPiD client"/>

<spid-example lang="java" src="/paylinks/src/main/java/no/spid/examples/PaylinksController.java" title="Create Paylink"/>

## :tab Clojure

<spid-example lang="clj" src="/paylinks/src/spid_clojure_paylinks_example/core.clj" title="Create SPiD client"/>

<spid-example lang="clj" src="/paylinks/src/spid_clojure_paylinks_example/core.clj" title="Create Paylink"/>

# :/tabs

## Redirect the user to Schibsted account for payment

Our new Paylink has [quite a few fields](/types/paylink/), but the one we're
interested in is the `shortUrl`. We'll use this to send the user to Schibsted account for
payment.

# :tabs

## :tab Java

<spid-example lang="java" src="/paylinks/src/main/java/no/spid/examples/PaylinksController.java" title="Create Paylink and redirect to SPiD"/>

## :tab Clojure

<spid-example lang="clj" src="/paylinks/src/spid_clojure_paylinks_example/core.clj" title="Create Paylink and redirect to SPiD"/>

# :/tabs

The user will be presented with a summary of the order, along with payment options.

## The user returns after completing the purchase

Schibsted account will redirect the user to your given `redirectUri` after a successful
purchase. It is a GET request, which includes two query parameters: `order_id` and `code`. We'll start with the latter:

### Make sure we've got the right user

The user might have logged in with a different user since we sent them to Schibsted account
(like on a shared computer). We need to ensure we're giving the purchased
product to the right user.

So, like in [the Implementing Single Sign-On guide](/implementing-sso/), we
create a session for the user with information from Schibsted account:

# :tabs

## :tab Java

<spid-example lang="java" src="/paylinks/src/main/java/no/spid/examples/PaylinksController.java" title="Handle callback from SPiD, make sure we've got the right user"/>

## :tab Clojure

<spid-example lang="clj" src="/paylinks/src/spid_clojure_paylinks_example/core.clj" title="Handle callback from SPiD, make sure we've got the right user"/>

# :/tabs

Note that the code has a short lifespan, so it is prudent to create the user
token with the code first, and then 302 redirect to another success landing page
with the code removed from the URL.

### Check the status of the order

Once we've got the right user, we can use the `order_id` to look up information
about the order.

# :tabs

## :tab Java

<spid-example lang="java" src="/paylinks/src/main/java/no/spid/examples/PaylinksController.java" title="Order status codes"/>

<spid-example lang="java" src="/paylinks/src/main/java/no/spid/examples/PaylinksController.java" title="Fetch order info"/>

## :tab Clojure

<spid-example lang="clj" src="/paylinks/src/spid_clojure_paylinks_example/core.clj" title="Order status codes"/>

<spid-example lang="clj" src="/paylinks/src/spid_clojure_paylinks_example/core.clj" title="Fetch order info"/>

# :/tabs

The order status is likely **Complete** (status `"2"`), meaning everything is
proceeding according to our plans. Time to give the user what they payed for.

#### Cancel

The user might also cancel the purchase, in which case they'll be redirected to
your given `cancelUri`. It will include a `spid_page` query parameter that
describes where in the process the user left.

## Working examples

If you're unsure on certain details after reading this guide, do check
out these working examples:

- [Paylinks example for Java](https://github.com/schibsted/spid-java-examples/tree/master/paylinks)
- [Paylinks example for Clojure](https://github.com/schibsted/spid-clj-examples/tree/master/paylinks)

## Further reading

- [Callbacks](/callbacks/) notifies you about changes to your orders.
