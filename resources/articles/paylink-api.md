:title The Paylink API
:frontpage
:category payment

:relevant-endpoints

POST /paylink
GET /paylink/{paylinkId}
DELETE /paylink/{paylinkId}

:aside

## Payment Platform API docs

- [Is hosted at Confluence](https://confluence.schibsted.io/display/SPDEV/)

## Relevant type definitions

- [Paylink](/types/paylink/)

:body

Paylinks allow clients to charge a customer for products without storing them in
SchAcc's product database. A paylink contains products, their prices and other
metadata. It comes with a URL that takes the user to SchAcc checkout where they
can pay for the products. Upon completion, the user is sent back to the client
with a confirmation from SchAcc. A paylink object represents a single purchase,
and may only be used once.

Paylink items are what end-users actually pay for. Each item has a price (which
is the total price, including VAT) and VAT, as well as other metadata. The total
price payed is the sum of each paylink item.

Paylink items can optionally be coupled to a current product in SPiD, identified
by the `productId` field. Paylink items also contain a type, indicating the kind
of item and how it is processed, tracked and visualized to the end-user.

By providing a `redirectUri` during the payment flow, the client can control
where the user is sent after successful payment. If one is not provided, the
client-default redirect URI will be used.

Both the whole paylink object and each paylink item have client reference
fields. These can be used by the client in order to track and process paylinks
and orders generated by them.

Each paylink item will generate a corresponding order item. The
`clientItemReference` for each paylink item will be added to each order item as
well as the `clientReference` for the paylink header, which will be added to the
order header. This enables clients to track each order item and each order using
their own references.

When using paylinks, it is **strongly** recommended to also implement the
[callback functionality](/callbacks/).

![Paylink schema](/images/paylinks-schema.png)

## Purchase flows

In the following diagrams, "SPiD API" is the REST API, and "SPiD Web" is SPiD in
the browser - the UI your users will see when entering credit cards, logging in
etc.

### Paylink direct purchase flow

Set `purchaseFlow` to `DIRECT` to use this flow. It is the default flow (when
`purchaseFlow` is omitted).

```sequence-diagram
Customer->Client: Ready to checkout
Note right of Customer: Before redirecting or showing\na purchase button/link, the client\nmust create a paylink serverside\nvia the API
Client->SPiD API: POST /paylink
SPiD API->Client: Responds with a paylink URI
Client->Customer: Show customer the paylink
Customer->SPiD Web: Customer clicks on the paylink, and is redirected to SPiD for checkout
Note left of SPiD Web: Customer authorizes the purchase which\nis based on the parameters created\nthrough the paylink API
SPiD Web->Client: Redirects customer back to the supplied redirect url with ?orderId=123
Client->SPiD API: Check order status: GET /order/123/status
SPiD API->Client: Return order and transaction objects
Note left of Client: Validate order status and\ninforms user that purchase\nis pending review
Client->Customer: Show confirmation
```
([Payment Platform now hosts order APIs](https://confluence.schibsted.io/display/SPDEV/The+Order+object) )

### Paylink authorize/capture flow

Set `purchaseFlow` to `AUTHORIZE` to use this flow.

```sequence-diagram
Customer->Client: Ready to checkout
Note right of Customer: Before redirecting or showing\na purchase button/link, the client\nmust create a paylink serverside\nvia the API
Client->SPiD API: POST /paylink
SPiD API->Client: Responds with a paylink URI
Client->Customer: Show customer the paylink
Customer->SPiD Web: Customer clicks on the paylink, and is redirected to SPiD for checkout
Note left of SPiD Web: Customer authorizes the purchase which\nis based on the parameters created\nthrough the paylink API
SPiD Web->Client: Redirects customer back to the supplied redirect url with ?orderId=123
Client->SPiD API: Check order status: GET /order/123/status
SPiD API->Client: Return order and transaction objects
Note left of Client: Validate order status and\ninforms user that purchase\nis pending review
Client->Customer: Show confirmation
Client->SPiD API: POST /order/123/capture
Note right of Client: Each time Client needs to capture an authorized order\n- fully or partially through order lines
SPiD API->Client: Respond with order and transaction objects
Client->SPiD API: (optional) POST /order/123/credit
Note right of Client: Each time Client needs to credit an order\n- fully or partially through order lines
SPiD API->Client: Respond with order and transaction objects
Client->SPiD API: (optional) POST /order/123/cancel
Note right of Client: Used when Client wants to cancel\na previous authorized order
SPiD API->Client: Respond with order and transaction objects
```
([Payment Platform now hosts order APIs](https://confluence.schibsted.io/display/SPDEV/The+Order+object#TheOrderobject-Authorize) )

